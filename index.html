<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>

   #header {
      text-align: right;
    }

    #buttonContainer {
      position: fixed;
      top: 20px;
      right: 20px;
    }

    button {
      background-color: blue;
      color: white;
      padding: 10px;
      border: none;
      cursor: pointer;
    }

.kinyButton {
      background-color: #ff0000;
      color: #ffffff;
    }

    .engButton {
      background-color: #00ff00;
      color: #000000;
    }

    .frButton {
      background-color: #0000ff;
      color: #ffffff;
    }


body {
  margin: 0 auto;
  max-width: 800px;
  padding: 0 20px;
}

.container {
  border: 2px solid #e0e8dc;
  border-radius: 5px;
  padding: 10px;
  margin: 10px 0;
}

.user-container {
  background-color: #18b615;
}

.assistant-container {
  background-color: #ddd;
}

.container::after {
  content: "";
  clear: both;
  display: table;
}

.container img {
  float: left;
  max-width: 60px;
  width: 100%;
  margin-right: 20px;
  border-radius: 50%;
}

.container img.right {
  float: right;
  margin-left: 20px;
  margin-right: 0;
}

.time-right {
  float: right;
  color: #aaa;
}

.time-left {
  float: left;
  color: #6fda5a;
}

h1 {
  background-color: skyblue;
}
 .floating-button {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: green;
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
    }
</style>
</head>
<body>
 <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
 <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
 <div id="header">
    <h1>Automated Chat Messages - Ask a Question</h1>
  </div>

  <div id="buttonContainer">
    <button onclick="showSwal()">Info</button>
  </div>
<button class="floating-button" onclick="showSms()">Recent chat</button>
<div id="chatbox">
  <div class="container assistant-container">
    
    <img src="/w3images/bandmember.jpg" alt="Avatar" class="right" style="width:100%;">

    <p><b>AI Assistant:</b> Hello. How are you today?</p>
  <span id="time" class="time-right">13:56</span>
  </div>
</div>

<div>
  <textarea id="userinput"></textarea>
  <button onclick="myDeterminat()">Ask</button>
</div>


<script> 

var timeString ="";
var extraHelp= ""
var extraHelpg= ""
var querrFoneNr=""
var ExrtraHelpTiT=""
var extraHelpswal="I'm sorry, but I don't have an answer for that yet. Please enter your phone number. I will notify you ASAP once the answer is found "
var morinfo="I'm sorry,  I don't have an answer for that right now !, I will give you the feedback  ASAP, after  to consulting an expert .  "

if (localStorage.getItem('myValueChat') === null) {
  // Get the current time
  

  // Store the current time in local storage
  localStorage.setItem('myValueChat', "All Chats");

 // console.log('Value stored:', currentTime);
} else {
  //alert('Value already exists:'+localStorage.getItem('myValueChat'));
}

var questnTxt ="What is your name?"
 var  questnAnswer="My name is Tubimenye smart solution Ltd AI Assistant"
 var decide = 0;
 let qaList = [];
 
 function startLoading() {
  Swal.fire({
    title: 'Loading .....',
    text:'Mutegereze gato AI model mushobora kuganira ',
    allowOutsideClick: false,
    didOpen: () => {
      Swal.showLoading();
      
    }
  });
}

var ivin= 0;

var chatData = [];


for (var ipsec = 0; ipsec < 50000; ipsec++) {
  chatData[ipsec] = "default" + ipsec;
  
  if (ipsec==49990){
  findinIt();
  }
}

const string1 = " it is ok  ";
//const strings =[ "The swift brown fox jumps xhtht over the lazy cat.",
//  "The quick fox jumps around the sleeping dog." ];
  var  strings = [];
function populate() {
  // chatData = [];

   strings = [
    "amakuru ki wageze yo ? nshaka ko unsobanurira makuzungu. xhtht Turareba mu igazeti tuba bwire ",
    "The quick fox jumps around the sleeping dog.",
    "A brown fox jumps over a drowsy dog.",
    "The quick brown rabbit leaps over the tired dog.",
    "A yego fox skips over the lazy dog.",
    "The swift brown fox jumps xhtht over the lazy cat.",
    "The quick brown yego fox  gracefully leaps xhtht over the snoozing dog.  ",
    "The quick brown yego xhtht fox jumps over the lazy dog",
    "The quick brown yego fox xhtht elegantly vaults over the sleepy dog.",
    "A quick brown dog leaps over the lazy fox."
  ];

  //alert("populated " + chatData.length);

  for (var index = 0; index < chatData.length; index++) {
    strings.push(chatData[index]);
    if (index==chatData.length-1000) 
          {
          checkCondition();
          //alert(strings[3000]);
          }
    
  }

  console.log(strings); // Output the populated array
}



let highestPercentage = 0;
let highestPercentageString = "";  

function myDeterminat() {


  

  // mainString = document.getElementById("userinput").value.trim().replace(/ {2,}|\?/g, " ");

  mainString = document.getElementById("userinput").value.trim().replace(/[?,.:;\-"(){}\/@]/g, " ");


  function calculateWordSimilarity(str1, str2) {
    const divider = "xhtht"

const symbolsToRemove = /[!?,.:;\-"'\(\)\{\}\/@]/g;

    

const words1 = str1.trim().toLowerCase().split(divider)[0].replace(symbolsToRemove, "").split(" ");
const words2 = str2.trim().toLowerCase().split(divider)[0].replace(symbolsToRemove, "").split(" ");


    //const words1 = str1.trim().toLowerCase().split(divider)[0].split(" ");
   // const words2 = str2.trim().toLowerCase().split(divider)[0].split(" ");

    const commonWords = words1.filter(word => words2.includes(word));
    const uncommonWords = words1.concat(words2).filter(word => !commonWords.includes(word));

    const similarityPercentage = (commonWords.length / words1.length) * 100;
    const uncommonWordCount = uncommonWords.length;

    return { similarityPercentage, uncommonWordCount };
  }

  let bestMatch = null;
  let bestMatchScore = -1;

  for (let i = 0; i < strings.length; i++) {
    const { similarityPercentage, uncommonWordCount } = calculateWordSimilarity(mainString, strings[i]);

    if (similarityPercentage > bestMatchScore || (similarityPercentage === bestMatchScore && uncommonWordCount < bestMatch.uncommonWordCount)) {
      bestMatch = { index: i, similarityPercentage, uncommonWordCount };
      bestMatchScore = similarityPercentage;
    }
  }

  console.log("Best match:", strings[bestMatch.index]);
  console.log("Similarity Percentage:", bestMatch.similarityPercentage);
  console.log("Uncommon Word Count:", bestMatch.uncommonWordCount);

  highestPercentageString=strings[bestMatch.index];
  
  const wordsCount = strings[bestMatch.index].split("xhtht")[0].split(" ").length;

//alert(wordsCount);
//alert(bestMatch.similarityPercentage+"%")

//alert(strings[bestMatch.index])

const uncommonWordPercentage = ((bestMatch.uncommonWordCount-1) / wordsCount) * 100;

 //alert(uncommonWordPercentage);
 


  alert("ub common "+uncommonWordPercentage)
  alert("similar "+bestMatch.similarityPercentage)

if (uncommonWordPercentage<50 &&bestMatch.similarityPercentage>35){
let parts = highestPercentageString.split("xhtht");

questnTxt=parts[0];
questnAnswer =parts[1]; 
//alert(questnTxt+"qst anser "+questnAnswer)

setAnsData()
decide =1;
 
     askQuestion()
 
 } else{

  decide=0;
  askQuestion()

 }

}


//https://docs.google.com/spreadsheets/d/1XdMhPVsxoem3_5QcwTZH1K3XPk8DHAYolARGhFUjuSI/edit?usp=sharing

function findinIt() {
  const base = 'https://docs.google.com/spreadsheets/d/1XdMhPVsxoem3_5QcwTZH1K3XPk8DHAYolARGhFUjuSI/gviz/tq?gid=0';
  
  
  const query = encodeURIComponent('Select B');
  const url = base + '&tq=' + query;

  fetch(url)
    .then(res => res.text())
    .then(rep => {
      const data = JSON.parse(rep.substr(47).slice(0, -2));
       const laNr= data.table.rows.length - 1;
      data.table.rows.forEach((main) => {
        main.c.forEach((ele) => {
          const text = ele.v;
          const searchTerm = "7894"; // Specify the search term here
           ivin++; 
           chatData[ivin]=text;
           if(ivin==2) {
          // alert("max number"+(laNr*1-3))
            startLoading();
           }
         if (ivin == (laNr*1-2)) {
       // alert("found "+ivin);
       
       // alert("booused"+text);
       
          populate ();
          }
              
        });
      });
    });
}



function checkCondition() {
  // Simulating a condition check
  setTimeout(() => {
    const conditionMet = Math.random() < 0.5; // Randomly true or false

    if (conditionMet) {
      Swal.close();
     // Swal.fire('Ready Now !', 'You aree the most welcome ! <br>Twabonetse ni  karibu na yombi.', 'success');
     showSwal();
    } else {
      setTimeout(checkCondition, 1000); // Check the condition again after 1 second
    }
  }, 2000);
}



const timeSpan = document.getElementById("time");


function updateTime() {
      const now = new Date();
       timeString = now.toLocaleTimeString();
      timeSpan.innerText = timeString;
    }

    function updateTimedyn() {
      const currentDate = new Date();
const year = currentDate.getFullYear();
const month = String(currentDate.getMonth() + 1).padStart(2, '0');
const day = String(currentDate.getDate()).padStart(2, '0');
const hours = String(currentDate.getHours()).padStart(2, '0');
const minutes = String(currentDate.getMinutes()).padStart(2, '0');

const formattedDate = `${year}-${month}-${day} ${hours}:${minutes}`;
timeString=formattedDate;
      
    }
updateTime()
var userInput = "";
var chatbox = document.getElementById("chatbox");
 
 
function setAnsData() {
  updateTimedyn();


    qaList = [
  {
    q: questnTxt,
    a: questnAnswer
  }
];

}

function displayMessage(sender, message, time) {
  let container = document.createElement("div");
  container.className = `container ${sender.toLowerCase()}-container`;

  if (sender !== 'AI Assistant') {
    container.style.backgroundColor = '#18b615'; // Apply green background color to user div
  }

  const imageSrc = sender === 'AI Assistant' ? '/w3images/bandmember.jpg' : '/w3images/avatar_g2.jpg';

  // Create the elements
  let image = document.createElement("img");
  image.src = imageSrc;
  image.alt = "Avatar";
  image.style.float = sender === 'AI Assistant' ? 'right' : 'left';
  image.style.width = "100%";

  let paragraph = document.createElement("p");
  let bold = document.createElement("b");
  bold.textContent = sender + ": ";
  paragraph.appendChild(bold);

  let messageText = document.createTextNode(""); // Empty text node
  paragraph.appendChild(messageText);

  let timeSpan = document.createElement("span");
  timeSpan.className = `time-${sender === 'AI Assistant' ? 'left' : 'right'}`;
  timeSpan.textContent = time;

  container.appendChild(image);
  container.appendChild(paragraph);
  container.appendChild(timeSpan);
  chatbox.appendChild(container);

  // Type out the message with a delay between characters
  let index = 0;
  const typingDelay = 60; // Delay in milliseconds between characters

  function typeMessage() {
    if (index < message.length) {
      messageText.textContent += message.charAt(index);
      index++;
      setTimeout(typeMessage, typingDelay);
    }
  }

  typeMessage();
}


function findMatchingQA(userInput) {
  for(let i = 0; i < qaList.length; i++) {
    if(userInput.toLowerCase() === qaList[i].q.toLowerCase()) {
      return qaList[i];
    }
  }
  return null;
}

function askQuestion() {
    if(decide==0){
  userInput = document.getElementById("userinput").value.trim(); 
    } else  {
          
        let parts = highestPercentageString.split("xhtht");
        
        
        
        userInput=parts[0]; 

    }
  if(userInput === "") {

    //alert("please ask some thing!!!!")

    pleaseask();
   
    return;
  }

  let matchingQA = findMatchingQA(userInput);
  if(matchingQA) {
    displayMessage("You", userInput, getCurrentTime());
    displayMessage("AI Assistant", matchingQA.a, getCurrentTime());

    localStorage.setItem('myValueChat',  localStorage.getItem('myValueChat')+ "<br> ------------- <br> <b> You: <i>   <span style='color: blue;'>       "+userInput+" </span> </i>  <br>  <u>Modified:   </u> "+questnTxt+"</b>  <br> <br> <u><b> AI Assistant: </b></u>"+questnAnswer +"<br><br> "+timeString);
    ssss 
} else {
    displayMessage("User", userInput, getCurrentTime());
    displayMessage("AI Assistant", "I'm sorry, but I don't have an answer for that yet.", getCurrentTime());
   // promptForPhoneNumber(userInput);

   extraHelp ="YOU:   "+document.getElementById("userinput").value.trim();
   extraHelpg = ""+document.getElementById("userinput").value.trim();
   
    showAlertHelp()
 
  }

  document.getElementById("userinput").value = "";
}

function getCurrentTime() {
  const currentTime = new Date();
  const timeString = currentTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  return timeString;
}


function showSms() {
    
    var sayit=localStorage.getItem('myValueChat')
      const boldText =sayit;
     

      const dialogContent = `
        <div>
          ${boldText}<br>
        </div>
      `;

      Swal.fire({
        html: dialogContent,
      
        title: 'Message Ziheruka/Recent Message',
        showCancelButton: true,
        confirmButtonText: 'OK Thanks',
        cancelButtonText: 'Cancel',
        footer: '<span>Powered By Tubimenye Smart Solution Ltd <br> <br> © Copyrighted Material  </span>'
        
      });
    }

   var languag= 0;
    function showSwal() {
        setTimeout(inforer, 2000);
       var readines='We are now Ready to help !'
          if (languag==0) {
          readines='We are now Ready to help !'
          }
          if (languag==1) {
          readines='Twiteguye kubafasha!'
          }
          if (languag==2) {
          readines='We are now Ready to help !'
          }
            if (languag==3) {
          readines='Nous sommes prêts à vous aider !'
          }
      Swal.fire({
        title:readines,
        html: '<div id="videoContainer">' +
                '<video id="videoPlayer" width="200" controls>' +
                  '<source src="https://github.com/E-somo/downloads/raw/main/New%20creative%20video.mp4" type="video/mp4">' +
                  'Your browser does not support HTML5 video.' +
                '</video>' +
              '</div>' +
              '<p id="swalText">Muraho Muhitemo <b> ururimi </b> tubafashamo <br> Morning please choose<b> language </b> we can Assist you  you in. <br> Bjr, Veuillez choisir la <b>langue</b> dans laquelle nous pouvons vous aider. </p>' +
              '<button onclick="buttonClicked(\'Kiny\')" class="kinyButton">KINY</button>' +
              '<button onclick="buttonClicked(\'ENG\')" class="engButton">ENG</button>' +
              '<button onclick="buttonClicked(\'FR\')" class="frButton">FR</button>',
        showCancelButton: true,
        allowOutsideClick:false,
        cancelButtonText: 'Cancel',
        confirmButtonText: 'Confirm',
         footer: '<span>Mushobora kubaza ikibazo cyose cy n <b> amategeko y umuhanda</b> <br>  Cg indi <b>serivise</b> yose itangwa na Tubimenye smart solution Ltd  </span>',
       
        didOpen: function() {
         // document.getElementById('videoPlayer').play();
          
        }
      });
    }

    function buttonClicked(lang) {
      var swalText = document.getElementById('swalText');
      if (lang === 'Kiny') {
        swalText.innerHTML = 'Turabafaha Mu Kinyarwanda ariko mushobora gukoresha n urundi rurimi ibitemewe ni ukuvangavanga indimi mu kibazo kimwe ! murakoze !  Twabakiriye na yombi !';
         languag =1;

         morinfo = "Munyihanganire gato !, nta gisubizo mfite none aha kuri iki kibazo!, ndakigarukaho mukanya nyuma yo kugisha inama impuguke."
         extraHelpswal = "Mumbabarire,  nta gisubizo mfite kuri  iki kibazo akakanya. Nyamuneka mwandike nimero yanyu ya terefone. Ndahita mbamenyesha byuhuse igisubizo kibonetse."

         ExrtraHelpTiT = "Ubufasha bwisumbuye";
         
      } else if (lang === 'ENG') {
        swalText.innerHTML = 'Ok we can  help you in English but you can use other languages,  but it is not allowed to mix languages  in the same question! Thank you! We welcome you!';
        languag =2; 
        morinfo = "Please bear with me!, I don't have an answer right now for this question!, I'll get back to you shortly after consulting an expert."
       
        extraHelpswal="I'm sorry, but I don't have an answer for that yet. Please enter your phone number. I will notify you ASAP once the answer is found "

        ExrtraHelpTiT = "Advanced help";
      } else if (lang === 'FR') {
        swalText.innerHTML = 'Ok on peut  vous aider en Français mais vous pouvez utiliser d autres langues, mais il n est pas permis de mélanger les langues dans la même question ! Merci! Nous vous souhaitons la bienvenue !';
        languag =3;
        ExrtraHelpTiT = "Aide avancée";

        morinfo = "S'il vous plaît, soyez indulgents avec moi !, je n'ai pas de réponse pour l'instant à cette question !, je vous répondrai peu après avoir consulté un expert."

extraHelpswal="Je suis désolé, mais je n'ai pas encore de réponse. Veuillez entrer votre numéro de téléphone. Je vous informerai dès que possible une fois la réponse trouvée"
      
      }
    }
    
    function inforer() {
    
     {
      var swalText = document.getElementById('swalText');
      if (languag === 1) {
        swalText.innerHTML = 'Turabafaha Mu Kinyarwanda ariko mushobora gukoresha n urundi rurimi ibitemewe ni ukuvangavanga indimi mu kibazo kimwe ! murakoze !  Twabakiriye na yombi !';
         
         
      } else if (languag === 2) {
        swalText.innerHTML = 'Ok we can  help you in English but you can use other languages,  but it is not allowed to mix languages  in the same question! Thank you! We welcome you!';
        
      } else if (languag === 3) {
        swalText.innerHTML = 'Ok on peut  vous aider en Français mais vous pouvez utiliser d autres langues, mais il n est pas permis de mélanger les langues dans la même question ! Merci! Nous vous souhaitons la bienvenue !';
       
      }
    }
    
    
    }
    

    function showAlertHelp() {
 // const inputValue = document.getElementById("myInput").value;
Swal.mixin({
  input: 'text',
  inputAttributes: {
    autocapitalize: 'off'
  },
  showCancelButton: true,
  confirmButtonText: 'Submit',
  allowOutsideClick:false,
  showLoaderOnConfirm: true,
  preConfirm: (value) => {
    return new Promise((resolve) => {
      if (isNaN(value)|| value=="") {
        Swal.showValidationMessage('Input must be a number');
        resolve();
      } else {
       
        //querrFoneNr=result.value;
       // alert(value)
       postQust()
        resolve(value);
      }
    });
  },
  allowOutsideClick: () => !Swal.isLoading()
}).fire({
  title: ExrtraHelpTiT,
 html: '<span style="color: blue;">' + extraHelp + ' <br> </span>  '+extraHelpswal,
  icon: 'info',
}).then((result) => {
  if (result.isConfirmed) {
    Swal.fire({
      title: 'Submitted',
      text: 'You entered: ' + result.value,
      icon: 'success'
    });
  }
});


}
    function postQust() {
      $.ajax({
        url: "https://docs.google.com/forms/d/e/1FAIpQLScYkkl7nR4mlpYQRHl8x15drieNZJCsXjnjz6jVBhMpQH5yXA/formResponse?",
        data: {
          "entry.661853647": ""+extraHelpg,
          "entry.972603255": "QryFrom "+localStorage.getItem('myValueChat').replace(/<b>/g, "")
         .replace(/<\/b>/g, "")
         .replace(/<br>/g, "")
         .replace(/<u>/g, "")
         .replace(/<\/u>/g, "")
         .replace(/<i>/g, "")
         .replace(/<\/i>/g, "")
         .replace(/<span style='color: blue;'>/g, "")
         .replace(/<\/span>/g, "").slice(-5000)
        },
        type: "POST",
        dataType: "xml",
        success: function (d) {
        //  alert("Successful");
        },
        error: function (x, y, z) {
         // alert("Failed");
        }
      });
    }
 

    function pleaseask() {
      Swal.fire({
        icon: 'warning',
        title: 'Gira icyo umbaza ! Please ask me something!',
        showConfirmButton: true,
        timer: 3100
      });
    }

</script>

</body>
</html>
